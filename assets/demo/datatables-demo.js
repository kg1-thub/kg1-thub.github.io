// Call the dataTables jQuery plugin
$(document).ready(function() {
  $('#dt18catcher').DataTable({
    order: [ [ 1, "desc" ] ],
    columnDefs: [
      { width: "8%", targets: 2 },
      { width: "8%", targets: 3 },
      { width: "8%", targets: 4 },
      { width: "8%", targets: 5 },
      { width: "8%", targets: 6 },
      { width: "8%", targets: 8 },
      { width: "8%", targets: 9 },
      { width: "8%", targets: 10 }
    ],
    searching: false,
    paging: false,
    info: false,
    // scrollX: true,
    // scrollCollapse: true,
    // fixedColumns: true
  });
});

$(document).ready(function() {
  $('#dt19catcher').DataTable({
    order: [ [ 1, "desc" ] ],
    columnDefs: [
      { width: "8%", targets: 2 },
      { width: "8%", targets: 3 },
      { width: "8%", targets: 4 },
      { width: "8%", targets: 5 },
      { width: "8%", targets: 6 },
      { width: "8%", targets: 8 },
      { width: "8%", targets: 9 },
      { width: "8%", targets: 10 }
    ],
    searching: false,
    paging: false,
    info: false,
    // scrollX: true,
    // scrollCollapse: true,
    // fixedColumns: true
  });
});

$(document).ready(function() {
  $('#dt19month').DataTable({
    order: [ [ 0, "asc" ] ],
    columnDefs: [
      { width: "17%", targets: 1 },
      { width: "17%", targets: 2 },
      { width: "17%", targets: 3 },
      { width: "11%", targets: 4 },
      { width: "11%", targets: 5 },
      { width: "11%", targets: 6 },
      { width: "11%", targets: 7 },
    ],
    searching: false,
    paging: false,
    info: false
  });
});

$(document).ready(function() {
  $('#dt19pitcher').DataTable({
    order: [ [ 1, "desc" ] ],
    columnDefs: [
      { width: "17%", targets: 1 },
      { width: "17%", targets: 2 },
      { width: "17%", targets: 3 },
      { width: "11%", targets: 4 },
      { width: "11%", targets: 5 },
      { width: "11%", targets: 6 },
      { width: "11%", targets: 7 },
    ],
    searching: false,
    paging: false,
    info: false
  });
});

$(document).ready(function() {
  $('#dt20catcher').DataTable({
    order: [ [ 1, "desc" ] ],
    columnDefs: [
      { width: "8%", targets: 2 },
      { width: "8%", targets: 3 },
      { width: "8%", targets: 4 },
      { width: "8%", targets: 5 },
      { width: "8%", targets: 6 },
      { width: "8%", targets: 7 },
      { width: "8%", targets: 9 },
      { width: "8%", targets: 10 },
      { width: "8%", targets: 11 }
    ],
    searching: false,
    paging: false,
    info: false
  });
});

$(document).ready(function() {
  $('#dt20month').DataTable({
    order: [ [ 0, "asc" ] ],
    columnDefs: [
      // { width: "17%", targets: 1 },
      // { width: "17%", targets: 2 },
      // { width: "17%", targets: 3 },
      // { width: "11%", targets: 4 },
    ],
    searching: false,
    paging: false,
    info: false
  });
});

$(document).ready(function() {
  $('#dt20pitcher').DataTable({
    order: [ [ 1, "desc" ], [ 2, "desc" ], [ 3, "desc" ]],
    columnDefs: [
      { width: "22%", targets: 1 },
      { width: "22%", targets: 2 },
      { width: "22%", targets: 3 },
      { width: "22%", targets: 4 },
    ],
    searching: false,
    paging: false,
    info: false
  });
});

$(document).ready(function() {
  $('#dt21catcher').DataTable({
    order: [ [ 1, "desc" ] ],
    columnDefs: [
      { width: "8%", targets: 2 },
      { width: "8%", targets: 3 },
      { width: "8%", targets: 4 },
      { width: "8%", targets: 5 },
      { width: "8%", targets: 6 },
      { width: "8%", targets: 7 },
      { width: "8%", targets: 9 },
      { width: "8%", targets: 10 },
      { width: "8%", targets: 11 }
    ],
    searching: false,
    paging: false,
    info: false
  });
});

$(document).ready(function() {
  $('#dt21month').DataTable({
    order: [ [ 0, "asc" ] ],
    columnDefs: [
      // { width: "17%", targets: 1 },
      // { width: "17%", targets: 2 },
      // { width: "17%", targets: 3 },
      // { width: "11%", targets: 4 },
    ],
    searching: false,
    paging: false,
    info: false
  });
});

$(document).ready(function() {
  $('#dt21pitcher').DataTable({
    order: [ [ 3, "desc" ], [ 1, "desc" ], [ 2, "desc" ]],
    columnDefs: [
      { width: "22%", targets: 1 },
      { width: "22%", targets: 2 },
      { width: "22%", targets: 3 },
      { width: "22%", targets: 4 },
    ],
    searching: false,
    paging: false,
    info: false
  });
});

$(document).ready(function() {
  $('#dt22catcher').DataTable({
    order: [ [ 1, "desc" ] ],
    columnDefs: [
      { width: "8%", targets: 2 },
      { width: "8%", targets: 3 },
      { width: "8%", targets: 4 },
      { width: "8%", targets: 5 },
      { width: "8%", targets: 6 },
      { width: "8%", targets: 7 },
      { width: "8%", targets: 9 },
      { width: "8%", targets: 10 },
      { width: "8%", targets: 11 }
    ],
    searching: false,
    paging: false,
    info: false
  });
});

$(document).ready(function() {
  $('#dt22month').DataTable({
    order: [ [ 0, "asc" ] ],
    columnDefs: [
      // { width: "17%", targets: 1 },
      // { width: "17%", targets: 2 },
      // { width: "17%", targets: 3 },
      // { width: "11%", targets: 4 },
    ],
    searching: false,
    paging: false,
    info: false
  });
});

$(document).ready(function() {
  $('#dt22pitcher').DataTable({
    // order: [ [ 3, "desc" ], [ 1, "desc" ], [ 2, "desc" ]],
    order: [[ 1, "desc" ]],
    columnDefs: [
      { width: "22%", targets: 1 },
      { width: "22%", targets: 2 },
      { width: "22%", targets: 3 },
      { width: "22%", targets: 4 },
    ],
    searching: false,
    paging: false,
    info: false
  });
});

// dt22games
function makeCSV(records, columns) {
  const divtable = document.getElementById('dt22games');
  const divcaption = document.createElement("caption");
  divcaption.setAttribute("id", "dt22gamescaption");
  divcaption.style.captionSide = "top";
  divcaption.style.fontSize = "1.4rem";
  divcaption.style.fontWeight = "300";
  divcaption.style.lineHeight = "1.2";
  divcaption.classList.add("pt-0");
  divcaption.classList.add("pb-0");
  var wls = [0, 0, 0];
  var ins_outs = [0, 0];
  var ers = 0;
  for (let i=0; i<records.length; i++) {
    if (records[i][0]=='W') {
      wls[0] += 1;
    } else if (records[i][0]=='L') {
      wls[1] += 1;
    } else if (records[i][0]=='S') {
      wls[2] += 1;
    }

    if (records[i][2].includes('.')) {
      var _ins_outs = records[i][2].split('.');
      ins_outs[0] += parseInt(_ins_outs[0]);
      ins_outs[1] += parseInt(_ins_outs[1]);
    } else {
      ins_outs[0] += parseInt(records[i][2]);
    }

    ers += parseInt(records[i][8]);
  }
  // divcaption.textContent = "勝-敗-S, 防御率 (イニング)";
  divcaption.textContent = ` ${wls[0]}勝 ${wls[1]}敗 ${wls[2]}S, 防御率 ${parseInt(ers/(ins_outs[0]*3+ins_outs[1])*27*100)/100} ( ${ins_outs[0]+parseInt(ins_outs[1]/3)+ins_outs[1]%3/10} 回 )`;
  divtable.appendChild(divcaption);

  const divthead = document.createElement("thead");
  divtable.appendChild(divthead);
  const divtheadr = document.createElement("tr");
  divthead.appendChild(divtheadr);
  let divth = document.createElement("th");
  divth.textContent = 'seq';
  divtheadr.appendChild(divth);
  for (var j = 0; j < columns.length; j++) {
      let divth = document.createElement("th");
      divth.textContent = columns[j];
      divtheadr.appendChild(divth);
  }

  const divtbody = document.createElement("tbody");
  divtable.appendChild(divtbody);
  for (var i = 0; i < records.length; i++) {
      let divtr = document.createElement("tr");
      divtbody.appendChild(divtr);
      let divtd = document.createElement("td");
      divtd.textContent = String(i);
      divtr.appendChild(divtd);
      for (var j = 0; j < columns.length; j++) {
          let divtd = document.createElement("td");
          if (j==1) {
            divtd.textContent = records[i][j].replace("　", "");
          } else if (j==10) {
            divtd.textContent = records[i][j].substr(5);
          } else if (j==12) {
            if (records[i][j]=="1") {
              divtd.textContent = "先発";
            } else {
              divtd.textContent = "交代";
            }
          } else {
            divtd.textContent = records[i][j];
          }
          divtr.appendChild(divtd);
      }
  }

  $(document).ready(function() {
      $('#dt22games').DataTable({
        order: [[ 0, "asc" ]],
        columnDefs: [
          { visible: false, targets: 0 },
          { width: "9%",    targets: 1 },
          { width: "13%",   targets: 2 },
          { width: "9%",    targets: 3 },
          { visible: false, targets: 4 },
          { visible: false, targets: 5 },
          { visible: false, targets: 6 },
          { visible: false, targets: 7 },
          { width: "9%",    targets: 8 },
          { width: "9%",    targets: 9 },
          { width: "13%",   targets: 10 },
          { width: "13%",   targets: 11 },
          { width: "13%",   targets: 12 },
          { width: "9%",    targets: 13 },
          { visible: false, targets: 14 },
        ],
        // dom: 'frtiQlp',
        dom: '<"float-left"f>rt<"float-left"p>',
        searching: true,
        search: {
          regex: true,
          search: "06/17" // @@KEYWORD@@
        },
        paging: true,
        info: false,
        // language: {
        //   searchPlaceholder: "search keyword"
        // }
        lengthMenu: [ 10, 30, 50 ],
        mark: true,
      }).on('search.dt', function() {
        var table = $('#dt22games').DataTable();

        var data = table.columns( [1, 3, 9] , {filter:'applied'}).data();
        var wls = [0, 0, 0];
        var ins_outs = [0, 0];
        var ers = 0;

        for (let i=0; i<data[0].length; i++) {
          if (data[0][i]=='W') {
            wls[0] += 1;
          } else if (data[0][i]=='L') {
            wls[1] += 1;
          } else if (data[0][i]=='S') {
            wls[2] += 1;
          }

          if (data[1][i].includes('.')) {
            var _ins_outs = data[1][i].split('.');
            ins_outs[0] += parseInt(_ins_outs[0]);
            ins_outs[1] += parseInt(_ins_outs[1]);
          } else {
            ins_outs[0] += parseInt(data[1][i]);
          }

          ers += parseInt(data[2][i]);
        }
        document.getElementById('dt22gamescaption').textContent = ` ${wls[0]}勝 ${wls[1]}敗 ${wls[2]}S, 防御率 ${parseInt(ers/(ins_outs[0]*3+ins_outs[1])*27*100)/100} ( ${ins_outs[0]+parseInt(ins_outs[1]/3)+ins_outs[1]%3/10} 回 )`;
      })
  });
};

function search_keyword(keyword) {
  var table = $('#dt22games').DataTable();
  table.search( keyword ).draw();
};

function search_today() {
  var today=new Date(); 
  var table = $('#dt22games').DataTable();
  table.search( ('0'+String(today.getMonth()+1)).slice(-2)+"/"+('0'+String(today.getDate())).slice(-2) ).draw();
};

window.onload = function() {
  if (location.search) {
    let params = new URLSearchParams(location.search.substring(1));
    var search = params.get("search");
    var query = decodeURI(search).replace(",", " ");
    search_keyword(query);
  }
};

{
  var fileurl = "https://raw.githubusercontent.com/kg1-thub/kg1-thub.github.io/master/assets/data/csv/catcher_stats22.csv";
  fetch(fileurl)
  .then(res => res.blob()) // Gets the response and returns it as a blob
  .then(blob => {
      var file = blob;
      var reader = new FileReader();
      reader.readAsText(file, 'Shift_JIS');
      reader.onload = function(event) {
          var textdata = event.target.result;
          var tmp = textdata.split("\n");
          // var cols = tmp[0].split(",");
          // var cols = ["wls","pitcher","innings","at_bats","hits","strikeouts","walks","runs","earned_runs","catcher","day_of_game","vs_team,starting,series"];
          var cols = ["勝敗S","投手","イニング","at_bats","hits","strikeouts","walks","失点","自責点","捕手","月日","対戦","出場","series"];
          var records = [];
          for (var i = 0; i < tmp.length-2; i++) {
              var row_data = tmp[i+1];
              records[i] = row_data.split(",");
          }
          makeCSV(records, cols);
      };
      reader.onerror = function() {
          alert("エラー：ファイルをロードできません。");
      };
  });
}
