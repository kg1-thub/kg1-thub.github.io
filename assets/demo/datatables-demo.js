// Call the dataTables jQuery plugin
$(document).ready(function() {
  $('#dt18catcher').DataTable({
    order: [ [ 1, "desc" ] ],
    columnDefs: [
      { width: "8%", targets: 2 },
      { width: "8%", targets: 3 },
      { width: "8%", targets: 4 },
      { width: "8%", targets: 5 },
      { width: "8%", targets: 6 },
      { width: "8%", targets: 8 },
      { width: "8%", targets: 9 },
      { width: "8%", targets: 10 }
    ],
    searching: false,
    paging: false,
    info: false,
    // scrollX: true,
    // scrollCollapse: true,
    // fixedColumns: true
  });
});

$(document).ready(function() {
  $('#dt19catcher').DataTable({
    order: [ [ 1, "desc" ] ],
    columnDefs: [
      { width: "8%", targets: 2 },
      { width: "8%", targets: 3 },
      { width: "8%", targets: 4 },
      { width: "8%", targets: 5 },
      { width: "8%", targets: 6 },
      { width: "8%", targets: 8 },
      { width: "8%", targets: 9 },
      { width: "8%", targets: 10 }
    ],
    searching: false,
    paging: false,
    info: false,
    // scrollX: true,
    // scrollCollapse: true,
    // fixedColumns: true
  });
});

$(document).ready(function() {
  $('#dt19month').DataTable({
    order: [ [ 0, "asc" ] ],
    columnDefs: [
      { width: "17%", targets: 1 },
      { width: "17%", targets: 2 },
      { width: "17%", targets: 3 },
      { width: "11%", targets: 4 },
      { width: "11%", targets: 5 },
      { width: "11%", targets: 6 },
      { width: "11%", targets: 7 },
    ],
    searching: false,
    paging: false,
    info: false
  });
});

$(document).ready(function() {
  $('#dt19pitcher').DataTable({
    order: [ [ 1, "desc" ] ],
    columnDefs: [
      { width: "17%", targets: 1 },
      { width: "17%", targets: 2 },
      { width: "17%", targets: 3 },
      { width: "11%", targets: 4 },
      { width: "11%", targets: 5 },
      { width: "11%", targets: 6 },
      { width: "11%", targets: 7 },
    ],
    searching: false,
    paging: false,
    info: false
  });
});

$(document).ready(function() {
  $('#dt20catcher').DataTable({
    order: [ [ 1, "desc" ] ],
    columnDefs: [
      { width: "8%", targets: 2 },
      { width: "8%", targets: 3 },
      { width: "8%", targets: 4 },
      { width: "8%", targets: 5 },
      { width: "8%", targets: 6 },
      { width: "8%", targets: 7 },
      { width: "8%", targets: 9 },
      { width: "8%", targets: 10 },
      { width: "8%", targets: 11 }
    ],
    searching: false,
    paging: false,
    info: false
  });
});

$(document).ready(function() {
  $('#dt20month').DataTable({
    order: [ [ 0, "asc" ] ],
    columnDefs: [
      // { width: "17%", targets: 1 },
      // { width: "17%", targets: 2 },
      // { width: "17%", targets: 3 },
      // { width: "11%", targets: 4 },
    ],
    searching: false,
    paging: false,
    info: false
  });
});

$(document).ready(function() {
  $('#dt20pitcher').DataTable({
    order: [ [ 1, "desc" ], [ 2, "desc" ], [ 3, "desc" ]],
    columnDefs: [
      { width: "22%", targets: 1 },
      { width: "22%", targets: 2 },
      { width: "22%", targets: 3 },
      { width: "22%", targets: 4 },
    ],
    searching: false,
    paging: false,
    info: false
  });
});

$(document).ready(function() {
  $('#dt21catcher').DataTable({
    order: [ [ 1, "desc" ] ],
    columnDefs: [
      { width: "8%", targets: 2 },
      { width: "8%", targets: 3 },
      { width: "8%", targets: 4 },
      { width: "8%", targets: 5 },
      { width: "8%", targets: 6 },
      { width: "8%", targets: 7 },
      { width: "8%", targets: 9 },
      { width: "8%", targets: 10 },
      { width: "8%", targets: 11 }
    ],
    searching: false,
    paging: false,
    info: false
  });
});

$(document).ready(function() {
  $('#dt21month').DataTable({
    order: [ [ 0, "asc" ] ],
    columnDefs: [
      // { width: "17%", targets: 1 },
      // { width: "17%", targets: 2 },
      // { width: "17%", targets: 3 },
      // { width: "11%", targets: 4 },
    ],
    searching: false,
    paging: false,
    info: false
  });
});

$(document).ready(function() {
  $('#dt21pitcher').DataTable({
    order: [ [ 3, "desc" ], [ 1, "desc" ], [ 2, "desc" ]],
    columnDefs: [
      { width: "22%", targets: 1 },
      { width: "22%", targets: 2 },
      { width: "22%", targets: 3 },
      { width: "22%", targets: 4 },
    ],
    searching: false,
    paging: false,
    info: false
  });
});

$(document).ready(function() {
  $('#dt22catcher').DataTable({
    order: [ [ 1, "desc" ] ],
    columnDefs: [
      { width: "8%", targets: 2 },
      { width: "8%", targets: 3 },
      { width: "8%", targets: 4 },
      { width: "8%", targets: 5 },
      { width: "8%", targets: 6 },
      { width: "8%", targets: 7 },
      { width: "8%", targets: 9 },
      { width: "8%", targets: 10 },
      { width: "8%", targets: 11 }
    ],
    searching: false,
    paging: false,
    info: false
  });
});

$(document).ready(function() {
  $('#dt22month').DataTable({
    order: [ [ 0, "asc" ] ],
    columnDefs: [
      // { width: "17%", targets: 1 },
      // { width: "17%", targets: 2 },
      // { width: "17%", targets: 3 },
      // { width: "11%", targets: 4 },
    ],
    searching: false,
    paging: false,
    info: false
  });
});

$(document).ready(function() {
  $('#dt22pitcher').DataTable({
    // order: [ [ 3, "desc" ], [ 1, "desc" ], [ 2, "desc" ]],
    order: [[ 1, "desc" ]],
    columnDefs: [
      // { width: "22%", targets: 1 },
      // { width: "22%", targets: 2 },
      // { width: "22%", targets: 3 },
      // { width: "22%", targets: 4 },
    ],
    searching: false,
    paging: false,
    info: false
  });
});

$(document).ready(function() {
  $('#dt23catcher').DataTable({
    order: [ [ 1, "desc" ] ],
    columnDefs: [
      { width: "8%", targets: 2 },
      { width: "8%", targets: 3 },
      { width: "8%", targets: 4 },
      { width: "8%", targets: 5 },
      { width: "8%", targets: 6 },
      { width: "8%", targets: 7 },
      { width: "8%", targets: 9 },
      { width: "8%", targets: 10 },
      { width: "8%", targets: 11 }
    ],
    searching: false,
    paging: false,
    info: false
  });
});

$(document).ready(function() {
  $('#dt23month').DataTable({
    order: [ [ 0, "asc" ] ],
    columnDefs: [
      // { width: "17%", targets: 1 },
      // { width: "17%", targets: 2 },
      // { width: "17%", targets: 3 },
      // { width: "11%", targets: 4 },
    ],
    searching: false,
    paging: false,
    info: false
  });
});

$(document).ready(function() {
  $('#dt23pitcher').DataTable({
    // order: [ [ 3, "desc" ], [ 1, "desc" ], [ 2, "desc" ]],
    order: [[ 1, "desc" ]],
    columnDefs: [
      // { width: "22%", targets: 1 },
      // { width: "22%", targets: 2 },
      // { width: "22%", targets: 3 },
      // { width: "22%", targets: 4 },
    ],
    searching: false,
    paging: false,
    info: false
  });
});

$(document).ready(function() {
  $('#dt24catcher').DataTable({
    order: [ [ 1, "desc" ] ],
    columnDefs: [
      { width: "8%", targets: 2 },
      { width: "8%", targets: 3 },
      { width: "8%", targets: 4 },
      { width: "8%", targets: 5 },
      { width: "8%", targets: 6 },
      { width: "8%", targets: 7 },
      { width: "8%", targets: 9 },
      { width: "8%", targets: 10 },
      { width: "8%", targets: 11 }
    ],
    searching: false,
    paging: false,
    info: false
  });
});

$(document).ready(function() {
  $('#dt24month').DataTable({
    order: [ [ 0, "asc" ] ],
    columnDefs: [
      // { width: "17%", targets: 1 },
      // { width: "17%", targets: 2 },
      // { width: "17%", targets: 3 },
      // { width: "11%", targets: 4 },
    ],
    searching: false,
    paging: false,
    info: false
  });
});

$(document).ready(function() {
  $('#dt24pitcher').DataTable({
    // order: [ [ 3, "desc" ], [ 1, "desc" ], [ 2, "desc" ]],
    order: [[ 1, "desc" ]],
    columnDefs: [
      // { width: "22%", targets: 1 },
      // { width: "22%", targets: 2 },
      // { width: "22%", targets: 3 },
      // { width: "22%", targets: 4 },
    ],
    searching: false,
    paging: false,
    info: false
  });
});

// dt24games
function makeCSV(records, columns, year) {
  const divtable = document.getElementById(`dt${year}games`);
  const divcaption = document.getElementById(`dt${year}gamescaption`);
  // const divcaption = document.createElement("caption");
  // divcaption.setAttribute("id", "dt"+year+"gamescaption");
  divcaption.style.captionSide = "top";
  divcaption.style.fontSize = "1.4rem";
  divcaption.style.fontWeight = "300";
  divcaption.style.lineHeight = "1.2";
  divcaption.classList.add("pt-0");
  divcaption.classList.add("pb-0");
  var wls = [0, 0, 0];
  var ins_outs = [0, 0];
  var ers = 0;
  var qs = 0;

  for (let i=0; i<records.length; i++) {
    if (records[i][0]=='W') {
      wls[0] += 1;
    } else if (records[i][0]=='L') {
      wls[1] += 1;
    } else if (records[i][0]=='S') {
      wls[2] += 1;
    }

    if (records[i][2].includes('.')) {
      var _ins_outs = records[i][2].split('.');
      ins_outs[0] += parseInt(_ins_outs[0]);
      ins_outs[1] += parseInt(_ins_outs[1]);
    } else {
      ins_outs[0] += parseInt(records[i][2]);
    }

    if (records[i][16]=='1' && parseFloat(records[i][2])>=6 && parseFloat(records[i][12])<=3)
    {
      qs += 1;
    }

    ers += parseInt(records[i][12]);
  }

  // divcaption.textContent = "勝-敗-S, 防御率 (イニング)";
  divcaption.textContent = ` ${wls[0]}勝 ${wls[1]}敗 ${wls[2]}S, 防御率 ${parseInt(ers/(ins_outs[0]*3+ins_outs[1])*27*100)/100} ( ${ins_outs[0]+parseInt(ins_outs[1]/3)+ins_outs[1]%3/10} 回 ) ${qs}QS`;
  // divtable.appendChild(divcaption);

  const divthead = document.createElement("thead");
  divtable.appendChild(divthead);
  const divtheadr = document.createElement("tr");
  divthead.appendChild(divtheadr);
  let divth = document.createElement("th");
  divth.textContent = 'seq';
  divtheadr.appendChild(divth);
  for (var j = 0; j < columns.length; j++) {
      let divth = document.createElement("th");
      divth.textContent = columns[j];
      divtheadr.appendChild(divth);
  }

  const divtbody = document.createElement("tbody");
  divtable.appendChild(divtbody);
  for (var i = 0; i < records.length; i++) {
      let divtr = document.createElement("tr");
      divtbody.appendChild(divtr);
      let divtd = document.createElement("td");
      divtd.textContent = String(i);
      divtr.appendChild(divtd);
      for (var j = 0; j < columns.length; j++) {
          let divtd = document.createElement("td");
          // if (j==1) {
          //   divtd.textContent = records[i][j].replace("　", "");
          // } else 
          if (j==14) {
            divtd.textContent = records[i][j].substr(5);
          } else if (j==16) {
            if (records[i][j]=="1") {
              divtd.textContent = "先発";
            } else {
              divtd.textContent = "交代";
            }
          } else {
            divtd.textContent = records[i][j];
          }
          divtr.appendChild(divtd);
      }
  }

  var keyword="";
  if (year == '24') {
    keyword = "07/15"; // @@KEYWORD@@
    $(document).ready(function() {
      $(`#dt${year}games`).DataTable({
        order: [[ 0, "asc" ]],
        columnDefs: [
          { visible: false, targets: 0 },
          { width: "5%", targets: 1 },
          { width: "9%", targets: 2 },
          { width: "6%", targets: 3 },
          { width: "5%", targets: 4 },
          { width: "5%", targets: 5 },
          { width: "5%", targets: 6 },
          { width: "5%", targets: 7 },
          { width: "5%", targets: 8 },
          { width: "5%", targets: 9 },
          { width: "5%", targets: 10 },
          { visible: false, targets: 11 },
          { width: "5%", targets: 12 },
          { width: "5%", targets: 13 },
          { width: "5%", targets: 14 },
          { width: "5%", targets: 15 },
          { width: "5%", targets: 16 },
          { width: "5%", targets: 17 },
          { visible: false, targets: 18 },
        ],
        // dom: 'frtiQlp',
        dom: '<"float-left"f>rt<"float-left"p>',
        searching: true,
        search: {
          regex: true,
          search: keyword
        },
        paging: true,
        info: false,
        // language: {
        //   searchPlaceholder: "search keyword"
        // }
        lengthMenu: [ 10, 30, 50 ],
        mark: true,
      }).on('search.dt', function() {
        var table = $(`#dt${year}games`).DataTable();

        var data = table.columns( [1, 3, 13, 17] , {filter:'applied'}).data();
        var wls = [0, 0, 0];
        var ins_outs = [0, 0];
        var ers = 0;
        var qs = 0;
        var st = 0

        for (let i=0; i<data[0].length; i++) {
          if (data[0][i]=='W') {
            wls[0] += 1;
          } else if (data[0][i]=='L') {
            wls[1] += 1;
          } else if (data[0][i]=='S') {
            wls[2] += 1;
          }

          if (data[1][i].includes('.')) {
            var _ins_outs = data[1][i].split('.');
            ins_outs[0] += parseInt(_ins_outs[0]);
            ins_outs[1] += parseInt(_ins_outs[1]);
          } else {
            ins_outs[0] += parseInt(data[1][i]);
          }

          if (data[3][i]=='先発') {
            st += 1;
            if (parseFloat(data[1][i])>=6 && parseFloat(data[2][i])<=3) {
              qs += 1;
            }
          }

          ers += parseInt(data[2][i]);
        }
        if (st==0){
          document.getElementById(`dt${year}gamescaption`).textContent = ` ${wls[0]}勝 ${wls[1]}敗 ${wls[2]}S, 防御率 ${parseInt(ers/(ins_outs[0]*3+ins_outs[1])*27*100)/100} ( ${ins_outs[0]+parseInt(ins_outs[1]/3)+ins_outs[1]%3/10} 回 )`;
        } else {
          document.getElementById(`dt${year}gamescaption`).textContent = ` ${wls[0]}勝 ${wls[1]}敗 ${wls[2]}S, 防御率 ${parseInt(ers/(ins_outs[0]*3+ins_outs[1])*27*100)/100} ( ${ins_outs[0]+parseInt(ins_outs[1]/3)+ins_outs[1]%3/10} 回 ) ${qs}QS, QS率 ${parseInt(qs/st*1000)/10}%`;
        }
      })
    });
  // } else {
  //   $(document).ready(function() {
  //     $(`#dt${year}games`).DataTable({
  //       order: [[ 0, "asc" ]],
  //       columnDefs: [
  //         { visible: false, targets: 0 },
  //         { width: "5%", targets: 1 },
  //         { width: "9%", targets: 2 },
  //         { width: "6%", targets: 3 },
  //         { width: "5%", targets: 4 },
  //         { width: "5%", targets: 5 },
  //         { width: "5%", targets: 6 },
  //         { width: "5%", targets: 7 },
  //         { width: "5%", targets: 8 },
  //         { width: "5%", targets: 9 },
  //         { width: "5%", targets: 10 },
  //         { visible: false, targets: 11 },
  //         { width: "5%", targets: 12 },
  //         { width: "5%", targets: 13 },
  //         { visible: false, targets: 14 },
  //       ],
  //       // dom: 'frtiQlp',
  //       dom: '<"float-left"f>rt<"float-left"p>',
  //       searching: true,
  //       search: {
  //         regex: true,
  //         search: keyword
  //       },
  //       paging: true,
  //       info: false,
  //       // language: {
  //       //   searchPlaceholder: "search keyword"
  //       // }
  //       lengthMenu: [ 10, 30, 50 ],
  //       mark: true,
  //     }).on('search.dt', function() {
  //       var table = $(`#dt${year}games`).DataTable();

  //       var data = table.columns( [1, 3, 13] , {filter:'applied'}).data();
  //       var wls = [0, 0, 0];
  //       var ins_outs = [0, 0];
  //       var ers = 0;
  //       var qs = 0;
  //       var st = 0

  //       for (let i=0; i<data[0].length; i++) {
  //         if (data[0][i]=='W') {
  //           wls[0] += 1;
  //         } else if (data[0][i]=='L') {
  //           wls[1] += 1;
  //         } else if (data[0][i]=='S') {
  //           wls[2] += 1;
  //         }

  //         if (data[1][i].includes('.')) {
  //           var _ins_outs = data[1][i].split('.');
  //           ins_outs[0] += parseInt(_ins_outs[0]);
  //           ins_outs[1] += parseInt(_ins_outs[1]);
  //         } else {
  //           ins_outs[0] += parseInt(data[1][i]);
  //         }

  //         if (data[3][i]=='先発') {
  //           st += 1;
  //           if (parseFloat(data[1][i])>=6 && parseFloat(data[2][i])<=3) {
  //             qs += 1;
  //           }
  //         }

  //         ers += parseInt(data[2][i]);
  //       }
  //       if (st==0){
  //         document.getElementById(`dt${year}gamescaption`).textContent = ` ${wls[0]}勝 ${wls[1]}敗 ${wls[2]}S, 防御率 ${parseInt(ers/(ins_outs[0]*3+ins_outs[1])*27*100)/100} ( ${ins_outs[0]+parseInt(ins_outs[1]/3)+ins_outs[1]%3/10} 回 )`;
  //       } else {
  //         document.getElementById(`dt${year}gamescaption`).textContent = ` ${wls[0]}勝 ${wls[1]}敗 ${wls[2]}S, 防御率 ${parseInt(ers/(ins_outs[0]*3+ins_outs[1])*27*100)/100} ( ${ins_outs[0]+parseInt(ins_outs[1]/3)+ins_outs[1]%3/10} 回 ) ${qs}QS, QS率 ${parseInt(qs/st*1000)/10}%`;
  //       }
  //     })
  //   });
  }
};

function search_keyword(keyword) {
  var table = $('#dt24games').DataTable();
  table.search( keyword ).draw();
};

function search_today() {
  var today=new Date(); 
  var table = $('#dt24games').DataTable();
  table.search( ('0'+String(today.getMonth()+1)).slice(-2)+"/"+('0'+String(today.getDate())).slice(-2) ).draw();
};

function csvLoad(year, team_initial="") {
  if (year == "24"){
    var cols = ["勝敗S","投手","投球回","球数","打者","被安","被本","三振","四球","死球","ボーク","失点","自責","捕手","月日","対戦","出場","series"];
  // } else {
  //   var cols = ["勝敗S","投手","投球回","打者","被安","三振","四球","失点","自責","捕手","月日","対戦","出場","series"];
  }
  // wls,pitcher,innings,pitches,at_bats,hits,homeruns,strikeouts,walks,hit_by_pitch,balks,runs,earned_runs,catcher,day_of_game,vs_team,starting,series
  var fileurl = `https://raw.githubusercontent.com/kg1-thub/kg1-thub.github.io/master/assets/data/csv/catcher_stats${year}${team_initial}.csv`;
  fetch(fileurl)
  .then(res => res.blob()) // Gets the response and returns it as a blob
  .then(blob => {
      console.log("LOAD TABLE");
      var file = blob;
      var reader = new FileReader();
      reader.readAsText(file, 'Shift_JIS');
      reader.onload = function(event) {
          var textdata = event.target.result;
          var tmp = textdata.split("\n");
          console.log(tmp);
          // var cols = tmp[0].split(",");
          var records = [];
          for (var i = 0; i < tmp.length-2; i++) {
              var row_data = tmp[i+1];
              records[i] = row_data.split(",");
          }
          makeCSV(records, cols, year);
      };
      reader.onerror = function() {
          alert("エラー：ファイルをロードできません。");
      };
  });
};

window.onload = function() {
  if (location.search) {
    let params = new URLSearchParams(location.search.substring(1));
    var search = params.get("search");
    var query = decodeURI(search).replace(",", " ");
    search_keyword(query);
  }
};

// document.getElementById('d2021').addEventListener('click', function() {
//   csvLoad('21');
// });

// {
//   // csvLoad('22');
//   // csvLoad('23');
//   csvLoad('24');
// }
